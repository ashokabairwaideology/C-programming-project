{\rtf1\ansi\ansicpg1252\deff0\deflang1033{\fonttbl{\f0\froman\fcharset0 Times New Roman;}{\f1\fswiss\fcharset0 Arial;}}
{\colortbl ;\red128\green0\blue128;\red0\green0\blue0;\red0\green128\blue128;\red128\green0\blue0;\red0\green0\blue255;}
{\*\generator Msftedit 5.41.15.1507;}\viewkind4\uc1\pard\sb100\sa100\cf1\b\f0\fs24 using \cf2\b0 System;\cf0\line\cf1\b using \cf2\b0 System.Drawing;\cf0\line\cf1\b using \cf2\b0 System.Collections;\cf0\line\cf1\b using \cf2\b0 System.ComponentModel;\cf0\line\cf1\b using \cf2\b0 System.Windows.Forms;\cf0\line\cf1\b using \cf2\b0 System.Data;\cf0\line\cf1\b using \cf2\b0 System.Net;\cf0\line\cf1\b using \cf2\b0 System.IO;\cf0\line\cf1\b using \cf2\b0 System.Net.Sockets;\cf0\line\cf1\b using \cf2\b0 System.Threading;\cf0\line\line\cf2 namespace Wrox.WindowsGUIProgramming.Chapter9\cf0\line\cf2\{\cf0\line\cf3 /// <summary>\cf0\line\cf3 /// Summary description for Form1.\cf0\line\cf3 /// </summary>\cf0\line\cf1\b public class \cf2\b0 ChatApplication : System.Windows.Forms.Form\cf0\line\cf2\{\cf0\line\cf2 internal System.Windows.Forms.ListBox listBox1;\cf0\line\cf1\b private \cf2\b0 System.Windows.Forms.TextBox txtMessage;\cf0\line\cf1\b private \cf2\b0 System.Windows.Forms.Button btSend;\cf0\line\cf3 /// <summary>\cf0\line\cf3 /// Required designer variable.\cf0\line\cf3 /// </summary>\cf0\line\cf1\b private \cf2\b0 System.ComponentModel.Container components = \cf1\b null\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 System.Windows.Forms.ComboBox cmdHost;\cf0\line\cf1\b private \cf2\b0 System.Windows.Forms.CheckBox chkSuspendClient;\cf0\line\line\cf1\b private \cf2\b0 PeerConnection p = \cf1\b null\cf2\b0 ;\cf0\line\line\cf1\b public \cf2\b0 ChatApplication()\cf0\line\cf2\{\cf0\line\cf3 //\cf0\line\cf3 // Required for Windows Form Designer support\cf0\line\cf3 //\cf0\line\cf2 InitializeComponent();\cf0\line\line\cf3 //\cf0\line\cf3 // TODO: Add any constructor code after InitializeComponent call\cf0\line\cf3 //\cf0\line\cf2 p = \cf1\b new \cf2\b0 PeerConnection(\cf4 4048\cf2 , listBox1, cmdHost);\cf0\line\cf2\}\cf0\line\line\cf3 /// <summary>\cf0\line\cf3 /// Clean up any resources being used.\cf0\line\cf3 /// </summary>\cf0\line\cf1\b protected \cf2\b0 override \cf1\b void \cf2\b0 Dispose( bool disposing )\cf0\line\cf2\{\cf0\line\cf1\b if\cf2\b0 ( disposing )\cf0\line\cf2\{\cf0\line\cf1\b if \cf2\b0 (components != \cf1\b null\cf2\b0 ) \cf0\line\cf2\{\cf0\line\cf2 components.Dispose();\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\cf2 base.Dispose( disposing );\cf0\line\cf2\}\cf0\line\line\cf2 #region Windows Form Designer generated code\cf0\line\cf3 /// <summary>\cf0\line\cf3 /// Required method for Designer support - do not modify\cf0\line\cf3 /// the contents of this method with the code editor.\cf0\line\cf3 /// </summary>\cf0\line\cf1\b private void \cf2\b0 InitializeComponent()\cf0\line\cf2\{\cf0\line\cf1\b this\cf2\b0 .listBox1 = \cf1\b new \cf2\b0 System.Windows.Forms.ListBox();\cf0\line\cf1\b this\cf2\b0 .txtMessage = \cf1\b new \cf2\b0 System.Windows.Forms.TextBox();\cf0\line\cf1\b this\cf2\b0 .btSend = \cf1\b new \cf2\b0 System.Windows.Forms.Button();\cf0\line\cf1\b this\cf2\b0 .cmdHost = \cf1\b new \cf2\b0 System.Windows.Forms.ComboBox();\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient = \cf1\b new \cf2\b0 System.Windows.Forms.CheckBox();\cf0\line\cf1\b this\cf2\b0 .SuspendLayout();\cf0\line\cf3 // \cf0\line\cf3 // listBox1\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .listBox1.Name = \cf5 "listBox1"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .listBox1.Size = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 688\cf2 , \cf4 394\cf2 );\cf0\line\cf1\b this\cf2\b0 .listBox1.TabIndex = \cf4 0\cf2 ;\cf0\line\cf3 // \cf0\line\cf3 // txtMessage\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .txtMessage.Location = \cf1\b new \cf2\b0 System.Drawing.Point(\cf4 8\cf2 , \cf4 408\cf2 );\cf0\line\cf1\b this\cf2\b0 .txtMessage.Name = \cf5 "txtMessage"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .txtMessage.Size = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 576\cf2 , \cf4 20\cf2 );\cf0\line\cf1\b this\cf2\b0 .txtMessage.TabIndex = \cf4 1\cf2 ;\cf0\line\cf1\b this\cf2\b0 .txtMessage.Text = \cf5 ""\cf2 ;\cf0\line\cf3 // \cf0\line\cf3 // btSend\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .btSend.Location = \cf1\b new \cf2\b0 System.Drawing.Point(\cf4 608\cf2 , \cf4 408\cf2 );\cf0\line\cf1\b this\cf2\b0 .btSend.Name = \cf5 "btSend"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .btSend.TabIndex = \cf4 2\cf2 ;\cf0\line\cf1\b this\cf2\b0 .btSend.Text = \cf5 "Send"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .btSend.Click += \cf1\b new \cf2\b0 System.EventHandler(\cf1\b this\cf2\b0 .btSend_Click);\cf0\line\cf3 // \cf0\line\cf3 // cmdHost\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .cmdHost.Location = \cf1\b new \cf2\b0 System.Drawing.Point(\cf4 8\cf2 , \cf4 432\cf2 );\cf0\line\cf1\b this\cf2\b0 .cmdHost.Name = \cf5 "cmdHost"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .cmdHost.Size = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 520\cf2 , \cf4 21\cf2 );\cf0\line\cf1\b this\cf2\b0 .cmdHost.TabIndex = \cf4 3\cf2 ;\cf0\line\cf1\b this\cf2\b0 .cmdHost.Text = \cf5 "localhost"\cf2 ;\cf0\line\cf3 // \cf0\line\cf3 // chkSuspendClient\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.Location = \cf1\b new \cf2\b0 System.Drawing.Point(\cf4 544\cf2 , \cf4 432\cf2 );\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.Name = \cf5 "chkSuspendClient"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.Size = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 152\cf2 , \cf4 24\cf2 );\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.TabIndex = \cf4 4\cf2 ;\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.Text = \cf5 "Suspend Client"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient.CheckedChanged += \cf1\b new \cf2\b0 System.EventHandler(\cf1\b this\cf2\b0 .chkSuspendClient_CheckedChanged);\cf0\line\cf3 // \cf0\line\cf3 // ChatApplication\cf0\line\cf3 // \cf0\line\cf1\b this\cf2\b0 .AutoScaleBaseSize = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 5\cf2 , \cf4 13\cf2 );\cf0\line\cf1\b this\cf2\b0 .ClientSize = \cf1\b new \cf2\b0 System.Drawing.Size(\cf4 688\cf2 , \cf4 462\cf2 );\cf0\line\cf1\b this\cf2\b0 .Controls.AddRange(\cf1\b new \cf2\b0 System.Windows.Forms.Control[] \{\cf0\line\cf1\b this\cf2\b0 .chkSuspendClient,\cf0\line\cf1\b this\cf2\b0 .cmdHost,\cf0\line\cf1\b this\cf2\b0 .btSend,\cf0\line\cf1\b this\cf2\b0 .txtMessage,\cf0\line\cf1\b this\cf2\b0 .listBox1\});\cf0\line\cf1\b this\cf2\b0 .MaximizeBox = \cf1\b false\cf2\b0 ;\cf0\line\cf1\b this\cf2\b0 .Name = \cf5 "ChatApplication"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .Text = \cf5 "Chat!"\cf2 ;\cf0\line\cf1\b this\cf2\b0 .ResumeLayout(\cf1\b false\cf2\b0 );\cf0\line\line\cf2\}\cf0\line\cf2 #endregion\cf0\line\line\cf3 /// <summary>\cf0\line\cf3 /// The main entry point for the application.\cf0\line\cf3 /// </summary>\cf0\line\cf2 [STAThread]\cf0\line\cf1\b static void \cf2\b0 Main() \cf0\line\cf2\{\cf0\line\cf2 Application.Run(\cf1\b new \cf2\b0 ChatApplication());\cf0\line\cf2\}\cf0\line\line\cf1\b private void \cf2\b0 btSend_Click(object sender, System.EventArgs e)\cf0\line\cf2\{\cf0\line\cf2 p.Write(txtMessage.Text);\cf0\line\cf2\}\cf0\line\line\cf1\b private void \cf2\b0 chkSuspendClient_CheckedChanged(object sender, System.EventArgs e)\cf0\line\cf2\{\cf0\line\cf1\b if\cf2\b0 (chkSuspendClient.Checked==\cf1\b true\cf2\b0 )\cf0\line\cf2\{\cf0\line\cf2 p.Enabled = \cf1\b true\cf2\b0 ;\cf0\line\cf2\}\cf0\line\cf1\b else\cf0\b0\line\cf2\{\cf0\line\cf2 p.Enabled = \cf1\b false\cf2\b0 ;\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\line\line\cf1\b public class \cf2\b0 PeerConnection\cf0\line\cf2\{\cf0\line\cf1\b private \cf2\b0 System.Net.Sockets.TcpListener peerListener = \cf1\b null\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 System.Net.Sockets.TcpClient peerClient = \cf1\b null\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 System.Net.Sockets.NetworkStream netStream = \cf1\b null\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 Thread t1 = \cf1\b null\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 IntPtr formHandle;\cf0\line\cf1\b private int \cf2\b0 port = \cf4 0\cf2 ;\cf0\line\cf1\b private \cf2\b0 bool clientEnabled = \cf1\b true\cf2\b0 ;\cf0\line\cf1\b private \cf2\b0 ListBox lb;\cf0\line\cf1\b private \cf2\b0 ComboBox cmb;\cf0\line\line\cf1\b public \cf2\b0 PeerConnection(\cf1\b int \cf2\b0 port, ListBox formHandle, ComboBox cmdHost)\cf0\line\cf2\{\cf0\line\cf1\b this\cf2\b0 .port = port;\cf0\line\cf1\b this\cf2\b0 .lb = formHandle;\cf0\line\cf1\b this\cf2\b0 .cmb = cmdHost;\cf0\line\cf2 t1 = \cf1\b new \cf2\b0 Thread(\cf1\b new \cf2\b0 ThreadStart(CreateListener));\cf0\line\cf2 t1.Name = \cf5 "Listener Thread"\cf2 ;\cf0\line\cf2 t1.Priority = ThreadPriority.AboveNormal;\cf0\line\cf2 t1.Start();\cf0\line\cf2\}\cf0\line\line\cf2 delegate \cf1\b void \cf2\b0 CallbackListbox(string message);\cf0\line\line\cf1\b void \cf2\b0 SetListboxString(string item)\cf0\line\cf2\{\cf0\line\cf2 lb.Items.Add(item);\cf0\line\cf2\}\cf0\line\line\cf1\b private void \cf2\b0 CreateListener()\cf0\line\cf2\{\cf0\line\cf2 Socket tc = \cf1\b null\cf2\b0 ;\cf0\line\line\cf2 peerListener = \cf1\b new \cf2\b0 TcpListener(port);\cf0\line\cf2 peerListener.Start();\cf0\line\line\cf2 CallbackListbox clb = \cf1\b new \cf2\b0 CallbackListbox(SetListboxString);\cf0\line\cf1\b while\cf2\b0 (\cf1\b true\cf2\b0 )\cf0\line\cf2\{\cf0\line\cf2 tc = peerListener.AcceptSocket();\cf0\line\cf1\b byte\cf2\b0 [] byMessage = \cf1\b new byte\cf2\b0 [\cf4 256\cf2 ];\cf0\line\cf2 Thread.Sleep(\cf4 500\cf2 );\cf0\line\cf1\b int \cf2\b0 iLength = tc.Receive(byMessage, \cf4 0\cf2 , byMessage.Length, SocketFlags.None); \cf0\line\cf1\b if\cf2\b0 (iLength>\cf4 0\cf2 )\cf0\line\cf2\{\cf0\line\cf2 string message = System.Text.Encoding.Default.GetString(byMessage);\cf0\line\cf1\b try\cf0\b0\line\cf2\{\cf0\line\cf1\b if\cf2\b0 (lb.InvokeRequired) lb.Invoke(clb, \cf1\b new \cf2\b0 object[]\{message\});\cf0\line\cf2\}\cf0\line\cf1\b catch\cf2\b0 (Exception e)\cf0\line\cf2\{\cf0\line\cf2 message = e.Message;\cf0\line\cf2\}\cf0\line\cf1\b finally\cf0\b0\line\cf2\{\cf0\line\cf2 System.Diagnostics.Debug.WriteLine(message);\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\line\cf1\b private void \cf2\b0 CreateClient(object message)\cf0\line\cf2\{\cf0\line\cf2 peerClient = \cf1\b new \cf2\b0 TcpClient();\cf0\line\cf2 peerClient.Connect(cmb.SelectedText, port);\cf0\line\line\cf2 netStream = peerClient.GetStream();\cf0\line\line\cf2 StreamWriter sw = \cf1\b new \cf2\b0 StreamWriter(netStream);\cf0\line\cf2 sw.Write((string)message);\cf0\line\cf2 sw.Flush();\cf0\line\line\cf2 peerClient.Close();\cf0\line\cf2\}\cf0\line\line\cf2 internal \cf1\b void \cf2\b0 Write(string message)\cf0\line\cf2\{\cf0\line\cf2 ThreadPool.QueueUserWorkItem(\cf1\b new \cf2\b0 WaitCallback(CreateClient), message);\cf0\line\cf2\}\cf0\line\line\cf2 internal bool Enabled\cf0\line\cf2\{\cf0\line\cf2 set\cf0\line\cf2\{\cf0\line\cf1\b if\cf2\b0 (t1.ThreadState==ThreadState.Suspended&&value==\cf1\b true\cf2\b0 )\cf0\line\cf2\{\cf0\line\cf2 t1.Resume();\cf0\line\cf2\}\cf0\line\cf1\b else if\cf2\b0 (t1.ThreadState!=ThreadState.Suspended&&value==\cf1\b false\cf2\b0 )\cf0\line\cf2\{\cf0\line\cf2 t1.Suspend();\cf0\line\cf2\}\cf0\line\cf2 clientEnabled = value;\cf0\line\cf2\}\cf0\line\cf2 get\cf0\line\cf2\{\cf0\line\cf1\b return \cf2\b0 clientEnabled;\cf0\line\cf2\} \cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\cf2\}\cf0\line\line\par
\pard\f1\fs20\par
}
 